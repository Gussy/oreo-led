/*
 * I2C_Lighting.c
 *
 * Created: 6/25/2014 3:37:19 PM
 *  Author: john
 */ 


#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <avr/cpufunc.h>
#include "TWI_Slave.h"

#define TWI_CMD_LIGHT_PULSE	0x10
#define TWI_CMD_LIGHT_ON	0x20
#define TWI_CMD_LIGHT_OFF	0x40

#define IOCLK_DIV1024	(1<<CS12)|(0<<CS11)|(1<<CS10)
#define IOCLK_DIV256	(1<<CS12)|(0<<CS11)|(0<<CS10)
#define IOCLK_DIV64		(0<<CS12)|(1<<CS11)|(1<<CS10)
#define IOCLK_DIV8		(0<<CS12)|(1<<CS11)|(0<<CS10)
#define IOCLK_DIV1		(0<<CS12)|(0<<CS11)|(1<<CS10)

#define COM1A_ENABLE (1<<COM1A1)|(0<<COM1A0)
#define COM1B_ENABLE (1<<COM1B1)|(0<<COM1B0)

#define FASTPWM_8BIT_A	(0<<WGM11)|(1<<WGM10)
#define FASTPWM_9BIT_A	(1<<WGM11)|(0<<WGM10)
#define FASTPWM_10BIT_A	(1<<WGM11)|(1<<WGM10)

#define FASTPWM_B (0<<WGM13)|(1<<WGM12)

int16_t current_comp_val = 0;

unsigned char TWI_Act_On_Failure_In_Last_Transmission ( unsigned char TWIerrorMsg );

/*	IOclk/FastPWM hertz table
	These are the 'easy' hertz rates to hit with the default timers
 				8bit	9bit	10bit
	IOCLK_1		4010	2005	1002.5
	IOCLK_8		501		250.5	125.25
	IOCLK_64	62.66	31.33	15.665
	IOCLK_256	15.65	7.825	3.9125
	IOCLK_1024	3.9		1.95	0.975 */

int main(void)
{
	unsigned char messageBuf[TWI_BUFFER_SIZE];
	unsigned char TWI_slaveAddress;  
	
	TWI_slaveAddress = 0x18;
	TWI_Slave_Initialise( (unsigned char)((TWI_slaveAddress<<TWI_ADR_BITS)));
	
	TWI_Start_Transceiver();
	
	//DDRB = (1<<DDB2);
	//PORTB = (1<<PB2);
	DDRB = (1<<DDB1)|(1<<DDB2);
	PORTB = 0x0;
	
	sei();
	
	
	TCCR1A = FASTPWM_10BIT_A|COM1B_ENABLE|COM1A_ENABLE;
	TCCR1B = (0<<ICNC1)|(0<<ICES1)|FASTPWM_B|IOCLK_DIV8;
	OCR1A = 0x32;
	OCR1B = 0x32;
	current_comp_val = 0x32;
	TIMSK1 |= (1<<TOIE1);
	
	
	while(1) { 
		;
	}		
/*		uint16_t samples = 0;
		for(samples=0; samples < 0x01ff; samples++) {
			if(samples < 0x0010) {
				PORTB |= (1<<PORTB1);
				} else {
				PORTB = 0;
			}
		}
		
	} */
	
    while(1)
    {
        if( ! TWI_statusReg.RxDataInBuf ) {
			if(TWI_Transceiver_Busy()) {
				MCUCR = (1<<SE)|(0<<SM1)|(0<<SM0); // Enable sleep with idle mode
			} else {
				MCUCR = (1<<SE)|(1<<SM1)|(0<<SM0); // Enable sleep with power-down mode
			}
			sleep_mode();
		} else {
			_NOP(); // There is data in the buffer, code below takes care of it.
		}
		
	    if ( ! TWI_Transceiver_Busy() )
	    {
			// Check if the last operation was successful
			if ( TWI_statusReg.lastTransOK )
			{
			    // Check if the last operation was a reception
				if ( TWI_statusReg.RxDataInBuf )
				{
				    TWI_Get_Data_From_Transceiver(messageBuf, 2);

					switch(messageBuf[0]){
						case TWI_CMD_LIGHT_OFF:
							break;
						case TWI_CMD_LIGHT_ON:
							break;
						case TWI_CMD_LIGHT_PULSE:
							break;
					}						
				}
				else // Ends up here if the last operation was a transmission
				{
				    _NOP(); // Put own code here.
				}
				// Check if the TWI Transceiver has already been started.
				// If not then restart it to prepare it for new receptions.
				if ( ! TWI_Transceiver_Busy() )
				{
				    TWI_Start_Transceiver();
				}
			}
			else // Ends up here if the last operation completed unsuccessfully
			{
			    TWI_Act_On_Failure_In_Last_Transmission( TWI_Get_State_Info() );
			}	
		}
	} 
}

#define SAFE_COMPARE 0x10f
uint8_t up = 0;

/* uint8_t heartbeat_values[256] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05,
	0x05, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x08, 0x08, 0x08, 0x09, 0x09, 0x0A, 0x0A, 0x0B, 0x0B,
	0x0C, 0x0C, 0x0D, 0x0D, 0x0E, 0x0F, 0x0F, 0x10, 0x11, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
	0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1F, 0x20, 0x21, 0x23, 0x24, 0x26, 0x27, 0x29, 0x2B, 0x2C,
	0x2E, 0x30, 0x32, 0x34, 0x36, 0x38, 0x3A, 0x3C, 0x3E, 0x40, 0x43, 0x45, 0x47, 0x4A, 0x4C, 0x4F,
	0x51, 0x54, 0x57, 0x59, 0x5C, 0x5F, 0x62, 0x64, 0x67, 0x6A, 0x6D, 0x70, 0x73, 0x76, 0x79, 0x7C,
	0x7F, 0x82, 0x85, 0x88, 0x8B, 0x8E, 0x91, 0x94, 0x97, 0x9A, 0x9C, 0x9F, 0xA2, 0xA5, 0xA7, 0xAA,
	0xAD, 0xAF, 0xB2, 0xB4, 0xB7, 0xB9, 0xBB, 0xBE, 0xC0, 0xC2, 0xC4, 0xC6, 0xC8, 0xCA, 0xCC, 0xCE,
	0xD0, 0xD2, 0xD3, 0xD5, 0xD7, 0xD8, 0xDA, 0xDB, 0xDD, 0xDE, 0xDF, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5,
	0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xED, 0xEE, 0xEF, 0xEF, 0xF0, 0xF1, 0xF1, 0xF2,
	0xF2, 0xF3, 0xF3, 0xF4, 0xF4, 0xF5, 0xF5, 0xF6, 0xF6, 0xF6, 0xF7, 0xF7, 0xF7, 0xF8, 0xF8, 0xF8,
	0xF9, 0xF9, 0xF9, 0xF9, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFC,
	0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD,
	0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF}; */
	
//uint8_t heartbeat10bit[1024] = {0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D, 0x0D, 0x0D, 0x0D, 0x0D, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x011, 0x011, 0x011, 0x011, 0x011, 0x012, 0x012, 0x012, 0x012, 0x013, 0x013, 0x013, 0x013, 0x013, 0x014, 0x014, 0x014, 0x014, 0x015, 0x015, 0x015, 0x015, 0x016, 0x016, 0x016, 0x016, 0x017, 0x017, 0x017, 0x017, 0x018, 0x018, 0x018, 0x019, 0x019, 0x019, 0x019, 0x01A, 0x01A, 0x01A, 0x01B, 0x01B, 0x01B, 0x01C, 0x01C, 0x01C, 0x01D, 0x01D, 0x01D, 0x01E, 0x01E, 0x01E, 0x01F, 0x01F, 0x01F, 0x020, 0x020, 0x021, 0x021, 0x021, 0x022, 0x022, 0x022, 0x023, 0x023, 0x024, 0x024, 0x025, 0x025, 0x025, 0x026, 0x026, 0x027, 0x027, 0x028, 0x028, 0x028, 0x029, 0x029, 0x02A, 0x02A, 0x02B, 0x02B, 0x02C, 0x02C, 0x02D, 0x02D, 0x02E, 0x02E, 0x02F, 0x02F, 0x030, 0x031, 0x031, 0x032, 0x032, 0x033, 0x033, 0x034, 0x035, 0x035, 0x036, 0x036, 0x037, 0x038, 0x038, 0x039, 0x039, 0x03A, 0x03B, 0x03B, 0x03C, 0x03D, 0x03D, 0x03E, 0x03F, 0x040, 0x040, 0x041, 0x042, 0x042, 0x043, 0x044, 0x045, 0x045, 0x046, 0x047, 0x048, 0x049, 0x049, 0x04A, 0x04B, 0x04C, 0x04D, 0x04E, 0x04E, 0x04F, 0x050, 0x051, 0x052, 0x053, 0x054, 0x055, 0x056, 0x056, 0x057, 0x058, 0x059, 0x05A, 0x05B, 0x05C, 0x05D, 0x05E, 0x05F, 0x060, 0x061, 0x062, 0x063, 0x064, 0x066, 0x067, 0x068, 0x069, 0x06A, 0x06B, 0x06C, 0x06D, 0x06F, 0x070, 0x071, 0x072, 0x073, 0x074, 0x076, 0x077, 0x078, 0x079, 0x07B, 0x07C, 0x07D, 0x07F, 0x080, 0x081, 0x083, 0x084, 0x085, 0x087, 0x088, 0x089, 0x08B, 0x08C, 0x08E, 0x08F, 0x091, 0x092, 0x094, 0x095, 0x097, 0x098, 0x09A, 0x09B, 0x09D, 0x09E, 0x0A0, 0x0A1, 0x0A3, 0x0A5, 0x0A6, 0x0A8, 0x0AA, 0x0AB, 0x0AD, 0x0AF, 0x0B0, 0x0B2, 0x0B4, 0x0B6, 0x0B7, 0x0B9, 0x0BB, 0x0BD, 0x0BF, 0x0C0, 0x0C2, 0x0C4, 0x0C6, 0x0C8, 0x0CA, 0x0CC, 0x0CE, 0x0D0, 0x0D2, 0x0D4, 0x0D6, 0x0D8, 0x0DA, 0x0DC, 0x0DE, 0x0E0, 0x0E2, 0x0E4, 0x0E6, 0x0E8, 0x0EA, 0x0EC, 0x0EE, 0x0F1, 0x0F3, 0x0F5, 0x0F7, 0x0F9, 0x0FC, 0x0FE, 0x0100, 0x0102, 0x0105, 0x0107, 0x0109, 0x010C, 0x010E, 0x0110, 0x0113, 0x0115, 0x0117, 0x011A, 0x011C, 0x011F, 0x0121, 0x0124, 0x0126, 0x0128, 0x012B, 0x012D, 0x0130, 0x0132, 0x0135, 0x0138, 0x013A, 0x013D, 0x013F, 0x0142, 0x0144, 0x0147, 0x014A, 0x014C, 0x014F, 0x0152, 0x0154, 0x0157, 0x015A, 0x015C, 0x015F, 0x0162, 0x0165, 0x0167, 0x016A, 0x016D, 0x0170, 0x0172, 0x0175, 0x0178, 0x017B, 0x017D, 0x0180, 0x0183, 0x0186, 0x0189, 0x018C, 0x018F, 0x0191, 0x0194, 0x0197, 0x019A, 0x019D, 0x01A0, 0x01A3, 0x01A6, 0x01A9, 0x01AC, 0x01AE, 0x01B1, 0x01B4, 0x01B7, 0x01BA, 0x01BD, 0x01C0, 0x01C3, 0x01C6, 0x01C9, 0x01CC, 0x01CF, 0x01D2, 0x01D5, 0x01D8, 0x01DB, 0x01DE, 0x01E1, 0x01E4, 0x01E7, 0x01EA, 0x01ED, 0x01F0, 0x01F3, 0x01F6, 0x01F9, 0x01FC, 0x01FF, 0x0202, 0x0205, 0x0208, 0x020B, 0x020E, 0x0211, 0x0214, 0x0217, 0x021A, 0x021D, 0x0220, 0x0223, 0x0226, 0x0229, 0x022C, 0x022F, 0x0232, 0x0235, 0x0238, 0x023B, 0x023E, 0x0241, 0x0244, 0x0247, 0x024A, 0x024D, 0x0250, 0x0252, 0x0255, 0x0258, 0x025B, 0x025E, 0x0261, 0x0264, 0x0267, 0x026A, 0x026D, 0x026F, 0x0272, 0x0275, 0x0278, 0x027B, 0x027E, 0x0281, 0x0283, 0x0286, 0x0289, 0x028C, 0x028E, 0x0291, 0x0294, 0x0297, 0x0299, 0x029C, 0x029F, 0x02A2, 0x02A4, 0x02A7, 0x02AA, 0x02AC, 0x02AF, 0x02B2, 0x02B4, 0x02B7, 0x02BA, 0x02BC, 0x02BF, 0x02C1, 0x02C4, 0x02C6, 0x02C9, 0x02CC, 0x02CE, 0x02D1, 0x02D3, 0x02D6, 0x02D8, 0x02DA, 0x02DD, 0x02DF, 0x02E2, 0x02E4, 0x02E7, 0x02E9, 0x02EB, 0x02EE, 0x02F0, 0x02F2, 0x02F5, 0x02F7, 0x02F9, 0x02FC, 0x02FE, 0x0300, 0x0302, 0x0305, 0x0307, 0x0309, 0x030B, 0x030D, 0x0310, 0x0312, 0x0314, 0x0316, 0x0318, 0x031A, 0x031C, 0x031E, 0x0320, 0x0322, 0x0324, 0x0326, 0x0328, 0x032A, 0x032C, 0x032E, 0x0330, 0x0332, 0x0334, 0x0336, 0x0338, 0x033A, 0x033C, 0x033E, 0x033F, 0x0341, 0x0343, 0x0345, 0x0347, 0x0348, 0x034A, 0x034C, 0x034E, 0x034F, 0x0351, 0x0353, 0x0354, 0x0356, 0x0358, 0x0359, 0x035B, 0x035D, 0x035E, 0x0360, 0x0361, 0x0363, 0x0364, 0x0366, 0x0367, 0x0369, 0x036A, 0x036C, 0x036D, 0x036F, 0x0370, 0x0372, 0x0373, 0x0375, 0x0376, 0x0377, 0x0379, 0x037A, 0x037B, 0x037D, 0x037E, 0x037F, 0x0381, 0x0382, 0x0383, 0x0385, 0x0386, 0x0387, 0x0388, 0x038A, 0x038B, 0x038C, 0x038D, 0x038E, 0x038F, 0x0391, 0x0392, 0x0393, 0x0394, 0x0395, 0x0396, 0x0397, 0x0398, 0x039A, 0x039B, 0x039C, 0x039D, 0x039E, 0x039F, 0x03A0, 0x03A1, 0x03A2, 0x03A3, 0x03A4, 0x03A5, 0x03A6, 0x03A7, 0x03A8, 0x03A8, 0x03A9, 0x03AA, 0x03AB, 0x03AC, 0x03AD, 0x03AE, 0x03AF, 0x03B0, 0x03B0, 0x03B1, 0x03B2, 0x03B3, 0x03B4, 0x03B5, 0x03B5, 0x03B6, 0x03B7, 0x03B8, 0x03B9, 0x03B9, 0x03BA, 0x03BB, 0x03BC, 0x03BC, 0x03BD, 0x03BE, 0x03BE, 0x03BF, 0x03C0, 0x03C1, 0x03C1, 0x03C2, 0x03C3, 0x03C3, 0x03C4, 0x03C5, 0x03C5, 0x03C6, 0x03C6, 0x03C7, 0x03C8, 0x03C8, 0x03C9, 0x03C9, 0x03CA, 0x03CB, 0x03CB, 0x03CC, 0x03CC, 0x03CD, 0x03CD, 0x03CE, 0x03CF, 0x03CF, 0x03D0, 0x03D0, 0x03D1, 0x03D1, 0x03D2, 0x03D2, 0x03D3, 0x03D3, 0x03D4, 0x03D4, 0x03D5, 0x03D5, 0x03D6, 0x03D6, 0x03D6, 0x03D7, 0x03D7, 0x03D8, 0x03D8, 0x03D9, 0x03D9, 0x03D9, 0x03DA, 0x03DA, 0x03DB, 0x03DB, 0x03DC, 0x03DC, 0x03DC, 0x03DD, 0x03DD, 0x03DD, 0x03DE, 0x03DE, 0x03DF, 0x03DF, 0x03DF, 0x03E0, 0x03E0, 0x03E0, 0x03E1, 0x03E1, 0x03E1, 0x03E2, 0x03E2, 0x03E2, 0x03E3, 0x03E3, 0x03E3, 0x03E4, 0x03E4, 0x03E4, 0x03E5, 0x03E5, 0x03E5, 0x03E5, 0x03E6, 0x03E6, 0x03E6, 0x03E7, 0x03E7, 0x03E7, 0x03E7, 0x03E8, 0x03E8, 0x03E8, 0x03E8, 0x03E9, 0x03E9, 0x03E9, 0x03E9, 0x03EA, 0x03EA, 0x03EA, 0x03EA, 0x03EB, 0x03EB, 0x03EB, 0x03EB, 0x03EB, 0x03EC, 0x03EC, 0x03EC, 0x03EC, 0x03ED, 0x03ED, 0x03ED, 0x03ED, 0x03ED, 0x03EE, 0x03EE, 0x03EE, 0x03EE, 0x03EE, 0x03EE, 0x03EF, 0x03EF, 0x03EF, 0x03EF, 0x03EF, 0x03F0, 0x03F0, 0x03F0, 0x03F0, 0x03F0, 0x03F0, 0x03F1, 0x03F1, 0x03F1, 0x03F1, 0x03F1, 0x03F1, 0x03F2, 0x03F2, 0x03F2, 0x03F2, 0x03F2, 0x03F2, 0x03F2, 0x03F3, 0x03F3, 0x03F3, 0x03F3, 0x03F3, 0x03F3, 0x03F3, 0x03F3, 0x03F4, 0x03F4, 0x03F4, 0x03F4, 0x03F4, 0x03F4, 0x03F4, 0x03F4, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F5, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F6, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F7, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F8, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03F9, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FA, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FB, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC, 0x03FC};
//uint8_t heartbeat10bit[512] = {0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D, 0x0D, 0x0D, 0x0D, 0x0D, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x010, 0x010, 0x010, 0x010, 0x010, 0x010, 0x011, 0x011, 0x011, 0x011, 0x011, 0x012, 0x012, 0x012, 0x012, 0x013, 0x013, 0x013, 0x013, 0x013, 0x014, 0x014, 0x014, 0x014, 0x015, 0x015, 0x015, 0x015, 0x016, 0x016, 0x016, 0x016, 0x017, 0x017, 0x017, 0x017, 0x018, 0x018, 0x018, 0x019, 0x019, 0x019, 0x019, 0x01A, 0x01A, 0x01A, 0x01B, 0x01B, 0x01B, 0x01C, 0x01C, 0x01C, 0x01D, 0x01D, 0x01D, 0x01E, 0x01E, 0x01E, 0x01F, 0x01F, 0x01F, 0x020, 0x020, 0x021, 0x021, 0x021, 0x022, 0x022, 0x022, 0x023, 0x023, 0x024, 0x024, 0x025, 0x025, 0x025, 0x026, 0x026, 0x027, 0x027, 0x028, 0x028, 0x028, 0x029, 0x029, 0x02A, 0x02A, 0x02B, 0x02B, 0x02C, 0x02C, 0x02D, 0x02D, 0x02E, 0x02E, 0x02F, 0x02F, 0x030, 0x031, 0x031, 0x032, 0x032, 0x033, 0x033, 0x034, 0x035, 0x035, 0x036, 0x036, 0x037, 0x038, 0x038, 0x039, 0x039, 0x03A, 0x03B, 0x03B, 0x03C, 0x03D, 0x03D, 0x03E, 0x03F, 0x040, 0x040, 0x041, 0x042, 0x042, 0x043, 0x044, 0x045, 0x045, 0x046, 0x047, 0x048, 0x049, 0x049, 0x04A, 0x04B, 0x04C, 0x04D, 0x04E, 0x04E, 0x04F, 0x050, 0x051, 0x052, 0x053, 0x054, 0x055, 0x056, 0x056, 0x057, 0x058, 0x059, 0x05A, 0x05B, 0x05C, 0x05D, 0x05E, 0x05F, 0x060, 0x061, 0x062, 0x063, 0x064, 0x066, 0x067, 0x068, 0x069, 0x06A, 0x06B, 0x06C, 0x06D, 0x06F, 0x070, 0x071, 0x072, 0x073, 0x074, 0x076, 0x077, 0x078, 0x079, 0x07B, 0x07C, 0x07D, 0x07F, 0x080, 0x081, 0x083, 0x084, 0x085, 0x087, 0x088, 0x089, 0x08B, 0x08C, 0x08E, 0x08F, 0x091, 0x092, 0x094, 0x095, 0x097, 0x098, 0x09A, 0x09B, 0x09D, 0x09E, 0x0A0, 0x0A1, 0x0A3, 0x0A5, 0x0A6, 0x0A8, 0x0AA, 0x0AB, 0x0AD, 0x0AF, 0x0B0, 0x0B2, 0x0B4, 0x0B6, 0x0B7, 0x0B9, 0x0BB, 0x0BD, 0x0BF, 0x0C0, 0x0C2, 0x0C4, 0x0C6, 0x0C8, 0x0CA, 0x0CC, 0x0CE, 0x0D0, 0x0D2, 0x0D4, 0x0D6, 0x0D8, 0x0DA, 0x0DC, 0x0DE, 0x0E0, 0x0E2, 0x0E4, 0x0E6, 0x0E8, 0x0EA, 0x0EC, 0x0EE, 0x0F1, 0x0F3, 0x0F5, 0x0F7, 0x0F9, 0x0FC, 0x0FE, 0x000, 0x002, 0x005, 0x007, 0x009, 0x00C, 0x00E, 0x010, 0x013, 0x015, 0x017, 0x01A, 0x01C, 0x01F, 0x021, 0x024, 0x026, 0x028, 0x02B, 0x02D, 0x030, 0x032, 0x035, 0x038, 0x03A, 0x03D, 0x03F, 0x042, 0x044, 0x047, 0x04A, 0x04C, 0x04F, 0x052, 0x054, 0x057, 0x05A, 0x05C, 0x05F, 0x062, 0x065, 0x067, 0x06A, 0x06D, 0x070, 0x072, 0x075, 0x078, 0x07B, 0x07D, 0x080, 0x083, 0x086, 0x089, 0x08C, 0x08F, 0x091, 0x094, 0x097, 0x09A, 0x09D, 0x0A0, 0x0A3, 0x0A6, 0x0A9, 0x0AC, 0x0AE, 0x0B1, 0x0B4, 0x0B7, 0x0BA, 0x0BD, 0x0C0, 0x0C3, 0x0C6, 0x0C9, 0x0CC, 0x0CF, 0x0D2, 0x0D5, 0x0D8, 0x0DB, 0x0DE, 0x0E1, 0x0E4, 0x0E7, 0x0EA, 0x0ED, 0x0F0, 0x0F3, 0x0F6, 0x0F9, 0x0FC, 0x0FF, 0x0, 0x0};

//uint8_t heartbeat10bit[502] = {2, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x08, 0x08, 0x08, 0x08, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0B, 0x0B, 0x0B, 0x0B, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D, 0x0D, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F, 0x010, 0x010, 0x010, 0x011, 0x011, 0x012, 0x012, 0x013, 0x013, 0x013, 0x014, 0x014, 0x015, 0x015, 0x016, 0x016, 0x017, 0x017, 0x018, 0x019, 0x019, 0x01A, 0x01A, 0x01B, 0x01C, 0x01C, 0x01D, 0x01E, 0x01E, 0x01F, 0x020, 0x021, 0x021, 0x022, 0x023, 0x024, 0x025, 0x025, 0x026, 0x027, 0x028, 0x029, 0x02A, 0x02B, 0x02C, 0x02D, 0x02E, 0x02F, 0x030, 0x031, 0x032, 0x033, 0x035, 0x036, 0x037, 0x038, 0x039, 0x03B, 0x03C, 0x03D, 0x03F, 0x040, 0x042, 0x043, 0x045, 0x046, 0x048, 0x049, 0x04B, 0x04D, 0x04E, 0x050, 0x052, 0x054, 0x056, 0x057, 0x059, 0x05B, 0x05D, 0x05F, 0x061, 0x063, 0x066, 0x068, 0x06A, 0x06C, 0x06F, 0x071, 0x073, 0x076, 0x078, 0x07B, 0x07D, 0x080, 0x083, 0x085, 0x088, 0x08B, 0x08E, 0x091, 0x094, 0x097, 0x09A, 0x09D, 0x0A0, 0x0A3, 0x0A6, 0x0AA, 0x0AD, 0x0B0, 0x0B4, 0x0B7, 0x0BB, 0x0BF, 0x0C2, 0x0C6, 0x0CA, 0x0CE, 0x0D2, 0x0D6, 0x0DA, 0x0DE, 0x0E2, 0x0E6, 0x0EA, 0x0EE, 0x0F3, 0x0F7, 0x0FC, 0x000, 0x005, 0x009, 0x00E, 0x013, 0x017, 0x01C, 0x021, 0x026, 0x02B, 0x030, 0x035, 0x03A, 0x03F, 0x044, 0x04A, 0x04F, 0x054, 0x05A, 0x05F, 0x065, 0x06A, 0x070, 0x075, 0x07B, 0x080, 0x086, 0x08C, 0x091, 0x097, 0x09D, 0x0A3, 0x0A9, 0x0AE, 0x0B4, 0x0BA, 0x0C0, 0x0C6, 0x0CC, 0x0D2, 0x0D8, 0x0DE, 0x0E4, 0x0EA, 0x0F0, 0x0F6, 0x0FC, 0x002, 0x008, 0x00E, 0x014, 0x01A, 0x020, 0x026, 0x02C, 0x032, 0x038, 0x03E, 0x044, 0x04A, 0x050, 0x055, 0x05B, 0x061, 0x067, 0x06D, 0x072, 0x078, 0x07E, 0x083, 0x089, 0x08E, 0x094, 0x099, 0x09F, 0x0A4, 0x0AA, 0x0AF, 0x0B4, 0x0BA, 0x0BF, 0x0C4, 0x0C9, 0x0CE, 0x0D3, 0x0D8, 0x0DD, 0x0E2, 0x0E7, 0x0EB, 0x0F0, 0x0F5, 0x0F9, 0x0FE, 0x002, 0x007, 0x00B, 0x010, 0x014, 0x018, 0x01C, 0x020, 0x024, 0x028, 0x02C, 0x030, 0x034, 0x038, 0x03C, 0x03F, 0x043, 0x047, 0x04A, 0x04E, 0x051, 0x054, 0x058, 0x05B, 0x05E, 0x061, 0x064, 0x067, 0x06A, 0x06D, 0x070, 0x073, 0x076, 0x079, 0x07B, 0x07E, 0x081, 0x083, 0x086, 0x088, 0x08B, 0x08D, 0x08F, 0x092, 0x094, 0x096, 0x098, 0x09B, 0x09D, 0x09F, 0x0A1, 0x0A3, 0x0A5, 0x0A7, 0x0A8, 0x0AA, 0x0AC, 0x0AE, 0x0B0, 0x0B1, 0x0B3, 0x0B5, 0x0B6, 0x0B8, 0x0B9, 0x0BB, 0x0BC, 0x0BE, 0x0BF, 0x0C1, 0x0C2, 0x0C3, 0x0C5, 0x0C6, 0x0C7, 0x0C8, 0x0C9, 0x0CB, 0x0CC, 0x0CD, 0x0CE, 0x0CF, 0x0D0, 0x0D1, 0x0D2, 0x0D3, 0x0D4, 0x0D5, 0x0D6, 0x0D7, 0x0D8, 0x0D9, 0x0D9, 0x0DA, 0x0DB, 0x0DC, 0x0DD, 0x0DD, 0x0DE, 0x0DF, 0x0E0, 0x0E0, 0x0E1, 0x0E2, 0x0E2, 0x0E3, 0x0E4, 0x0E4, 0x0E5, 0x0E5, 0x0E6, 0x0E7, 0x0E7, 0x0E8, 0x0E8, 0x0E9, 0x0E9, 0x0EA, 0x0EA, 0x0EB, 0x0EB, 0x0EB, 0x0EC, 0x0EC, 0x0ED, 0x0ED, 0x0EE, 0x0EE, 0x0EE, 0x0EF, 0x0EF, 0x0EF, 0x0F0, 0x0F0, 0x0F0, 0x0F1, 0x0F1, 0x0F1, 0x0F2, 0x0F2, 0x0F2, 0x0F3, 0x0F3, 0x0F3, 0x0F3, 0x0F4, 0x0F4, 0x0F4, 0x0F4, 0x0F5, 0x0F5, 0x0F5, 0x0F5, 0x0F5, 0x0F6, 0x0F6, 0x0F6, 0x0F6, 0x0F6, 0x0F7, 0x0F7, 0x0F7, 0x0F7, 0x0F7, 0x0F7, 0x0F8, 0x0F8, 0x0F8, 0x0F8, 0x0F8, 0x0F8, 0x0F9, 0x0F9, 0x0F9, 0x0F9, 0x0F9, 0x0F9, 0x0F9, 0x0F9, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FA, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB, 0x0FB};

uint8_t heartbeat10bit[256] = { 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x08, 0x08, 0x08, 0x08, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0B, 0x0B, 0x0B, 0x0B, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D, 0x0D, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F, 0x010, 0x010, 0x010, 0x011, 0x011, 0x012, 0x012, 0x013, 0x013, 0x013, 0x014, 0x014, 0x015, 0x015, 0x016, 0x016, 0x017, 0x017, 0x018, 0x019, 0x019, 0x01A, 0x01A, 0x01B, 0x01C, 0x01C, 0x01D, 0x01E, 0x01E, 0x01F, 0x020, 0x021, 0x021, 0x022, 0x023, 0x024, 0x025, 0x025, 0x026, 0x027, 0x028, 0x029, 0x02A, 0x02B, 0x02C, 0x02D, 0x02E, 0x02F, 0x030, 0x031, 0x032, 0x033, 0x035, 0x036, 0x037, 0x038, 0x039, 0x03B, 0x03C, 0x03D, 0x03F, 0x040, 0x042, 0x043, 0x045, 0x046, 0x048, 0x049, 0x04B, 0x04D, 0x04E, 0x050, 0x052, 0x054, 0x056, 0x057, 0x059, 0x05B, 0x05D, 0x05F, 0x061, 0x063, 0x066, 0x068, 0x06A, 0x06C, 0x06F, 0x071, 0x073, 0x076, 0x078, 0x07B, 0x07D, 0x080, 0x083, 0x085, 0x088, 0x08B, 0x08E, 0x091, 0x094, 0x097, 0x09A, 0x09D, 0x0A0, 0x0A3, 0x0A6, 0x0AA, 0x0AD, 0x0B0, 0x0B4, 0x0B7, 0x0BB, 0x0BF, 0x0C2, 0x0C6, 0x0CA, 0x0CE, 0x0D2, 0x0D6, 0x0DA, 0x0DE, 0x0E2, 0x0E6, 0x0EA, 0x0EE, 0x0F3, 0x0F7, 0x0FC, 0x000, 0x005, 0x009, 0x00E, 0x013, 0x017, 0x01C, 0x021, 0x026, 0x02B, 0x030, 0x035, 0x03A, 0x03F, 0x044, 0x04A, 0x04F, 0x054, 0x05A, 0x05F, 0x065, 0x06A, 0x070, 0x075, 0x07B, 0x080, 0x086, 0x08C, 0x091, 0x097, 0x09D, 0x0A3, 0x0A9, 0x0AE, 0x0B4, 0x0BA, 0x0C0, 0x0C6, 0x0CC, 0x0D2, 0x0D8, 0x0DE, 0x0E4, 0x0EA, 0x0F0, 0x0F6, 0x0FC };

uint8_t count = 0x32;
ISR(TIMER1_OVF_vect)
{
/*	if(up){
		current_comp_val++;
		if(current_comp_val >= SAFE_COMPARE) {
			up = 0;
		}
	} else {
		current_comp_val--;
		if(current_comp_val <= 0) {
			up = 1;
			current_comp_val = 0;
		}
	} */
	if(up) {
		count++;
		if(count==255) {
			up = 0;
		}
	} else {
		count--;
		if(count==0) {
			up = 1;
		}
	}
	uint8_t highbit = 0;
	if(count>=208){
		 highbit = 1;
	}		 
	current_comp_val = (highbit<<8) | heartbeat10bit[count];
	OCR1B = current_comp_val;
	OCR1A = current_comp_val;
}

unsigned char TWI_Act_On_Failure_In_Last_Transmission ( unsigned char TWIerrorMsg )
{
	// A failure has occurred, use TWIerrorMsg to determine the nature of the failure
	// and take appropriate actions.
	// Se header file for a list of possible failures messages.
	
	// This very simple example puts the error code on PORTB and restarts the transceiver with
	// all the same data in the transmission buffers.
	//PORTB = TWIerrorMsg;
	TWI_Start_Transceiver();
	
	return TWIerrorMsg;
} 